# 4. 커넥션 풀

# 4. 커넥션 풀

## DriverManager와 DB 커넥션

### 데이터베이스 커넥션을 매번 획득

![Untitled](/image/database/lecture/4/Untitled.png)

DB에 접근하기 위해서는 반드시 DB 커넥션이 필요하다. 그런데 JDBC의 DB 드라이버를 이용하는 경우 매번 DB 커넥션을 맺고 끊어야한다는 문제점이 있다. 어떤 문제가 있을까?

다음은 사용자 요청이 왔을 때 DB 커넥션을 가져오는 방법이다.

1. 서비스 계층, 비즈니스 로직은 DB 드라이버를 통해 커넥션을 조회한다.
2. **DB 드라이버는 DB와 TCP/IP 커넥션을 연결한다. 이 과정에서 네트워크 연결을 위한 3 way-handshaking 같은 네트워크 동작이 발생한다.**
3. **DB 드라이버는 TCP/IP 커넥션이 연결되면 DB에 인증정보를 전달해준다.**
4. **DB는 인증정보를 바탕으로 인가해준다. 인가 처리가 완료되면 DB 세션이 생긴다.**
5. DB는 세션이 생성되면 커넥션이 완료된 것을 DB 드라이버에게 전달해준다.
6. 응답을 받은 DB 드라이버는 커넥션 객체를 생성하고 그것을 비즈니스 로직/ 서비스 계층에게 반환해준다.

요청이 올 때마다 DB 커넥션을 새로 만드는 것은 과정도 복잡하고 시간이 많이 소요되는 일이다. **기본적으로 TCP/IP 연결을 맺기 위해 TCP/IP 통신을 하는 것은 꽤 많은 비용이 든다.** 이런 이유 때문에 요청이 올 때마다 DB 커넥션을 만드는 일은 클라이언트 / 서버 / DB 입장에서 많은 리소스가 필요한 일이 된다.

사용자 입장에서는 SQL이 실행되어 결과가 전달될 때까지의 시간 뿐만 아니라, DB 커넥션을 맺어야 하는 시간까지 필요하기 때문에 나쁜 유저 경험을 하게 된다. **따라서 매번 DB 커넥션을 맺어야 하는 부분의 최적화가 필요한데 ‘커넥션 풀’을 통해 이 문제를 해결한다.**

## 커넥션 풀

**커넥션 풀은 미리 커넥션을 만들어서 풀 형태로 관리한다. 커넥션 요청이 올 경우, 해당 커넥션을 빌려주고 커넥션을 다 쓴 사용자가 반환**하면 다시 그 풀을 관리하는 형태로 동작한다.

### 커넥션 풀 초기화

![Untitled](/image/database/lecture/4/Untitled%201.png)

**어플리케이션 시작 시점에 커넥션 풀은 필요한 만큼의 커넥션을 미리 확보해서 풀에 보관해둔다.** 커넥션 풀에 보관하는 커넥션의 최대 갯수는 서버 / 어플리케이션 종류 / DB 스펙마다 다르지만, 기본값은 보통 10개로 설정된다고 한다.

### 커넥션 풀 연결 상태

![Untitled](/image/database/lecture/4/Untitled%202.png)

커넥션 풀에 있는 커넥션은 DB와 TCP/IP를 통해서 연결이 되어있는 상황이다. 그리고 각 커넥션은 그에 해당되는 각각의 DB 세션이 존재한다. 커넥션은 TCP/IP 연결이 되어있는 상태기 때문에 SQL이 오면, 바로 DB에 SQL문을 보내서 세션을 통해 실행할 수 있다.

### 커넥션 풀 사용

![Untitled](/image/database/lecture/4/Untitled%203.png)

- 어플리케이션이 DB에 접근이 필요한 경우, 커넥션 풀에 커넥션을 요청한다.
- 커넥션 풀은 어플리케이션에게 가지고 있던 커넥션을 제공한다. 이때, 어플리케이션은 커넥션을 객체 참조로 가져다 사용한다.

![Untitled](/image/database/lecture/4/Untitled%204.png)

- 어플리케이션은 커넥션 풀에게서 전달받은 커넥션을 이용해 DB에서 필요한 데이터를 성공적으로 가져와 비즈니스 로직을 마무리한다.
- 어플리케이션은 커넥션을 다 사용하고 나면, 커넥션을 다시 커넥션 풀에 반환한다. 커넥션 풀은 반환된 커넥션을 다시 커넥션 풀에서 관리한다. 그리고 추후에 다시 커넥션 요청이 올 경우, 커넥션을 재사용할 수 있도록 한다.

커넥션 풀은 다음과 같은 형태로 사용이 된다. 이때, DriverManager를 사용해 커넥션을 얻던 시절과 달라지는 점은 크게 두가지가 있다.

1. 커넥션풀의 커넥션은 이미 DB 연결이 되어있다. 따라서 DB와 TCP/IP 통신을 통해 연결하는 절차가 생략된다.
2. 다 사용된 커넥션은 커넥션 풀에 반납해야한다. 이전에는 커넥션을 닫았지만, 커넥션을 닫는 경우 커넥션을 사용하지 못하게 된다. 따라서 커넥션을 반납해야 한다.

## H2 DB에서 커넥션/세션 확인하기

DB와 TCP/IP 통신을 통해 커넥션을 맺는 것을 H2 DB를 이용해 확인해보자.

![Untitled](/image/database/lecture/4/Untitled%205.png)

H2 DB에 접속하면 다음과 같은 웹 페이지가 뜬다. 현재 이 상태는 DB와 내 웹브라우저가 통신을 통해서 결과를 전송받은 상태라고 볼 수 있다. 이 때, 사용자명과 비밀번호를 치고 연결을 누르면

1. TCP/IP 연결을 한다.(3way-handshaking)
2. TCP/IP 연결이 완료되면 사용자명 / 비밀번호를 DB에 전달한다.
3. DB는 인증정보를 바탕으로 인가처리를 하고 응답해준다.

![Untitled](/image/database/lecture/4/Untitled%206.png)

응답하면 다음과 같은 화면을 볼 수 있다. 현재 이 상태는 DB와 내 웹브라우저가 커넥션이 생성되었고 연결되어있는 상태다. 그리고 현재 내 웹브라우저에 해당되는 세션이 DB에 생성되어있는 상태이다. 여기서 SQL문을 작성해서 보내면 내 커넥션을 통해 세션에 SQL이 전달되고 세션을 통해 SQL이 실행된다.

## 정리

1. 커넥션 풀을 이용해 미리 만들어 둔 커넥션을 요청이 올 때마다 전달해주면서 TCP/IP 연결 비용을 최소화한다.
2. 커넥션 풀의 적절한 커넥션 숫자는 서비스 특징/ 어플리케이션 서버 스펙/ DB 서버 스펙에 따라 다르다. 이는 성능 테스트를 통해 결정해야한다. 기본값은 10이다.
3. 커넥션 풀은 서버 당 최대 커넥션 수를 제한한다. 따라서 DB를 보호하는 방법이 될 수 있다. 예를 들어 무한정 DB 커넥션을 생성할 경우 무한히 많은 DB 세션이 생기면서 DB가 다운될 수 있다.
4. 스프링부트는 기본적으로 커넥션 풀을 사용한다. 스프링부트가 기본적으로 사용하는 커넥션 풀은 HikariCp다.
